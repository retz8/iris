---
goal: n8n Workflow 1 — Weekly Newsletter Content Pipeline
version: 1.0
date_created: 2026-02-18
status: 'Planned'
tags: [feature, n8n, newsletter, content-pipeline]
---

# n8n Workflow 1: Weekly Newsletter Content Pipeline

![Status: Planned](https://img.shields.io/badge/status-planned-blue)

Automates weekly newsletter content creation every Sunday at 8pm. Discovers trending IT topics via Perplexity (web search), finds relevant GitHub repos, extracts code snippets, generates breakdowns via Claude Haiku, composes HTML emails, saves as Gmail drafts for human review, and writes tracking rows to Google Sheets. Output: 3 Gmail drafts (one per language variant: Python, JS/TS, C/C++) ready for Sunday review before Monday/Wednesday/Friday send.

## 1. Requirements & Constraints

- **REQ-001**: Workflow runs every Sunday at 20:00 local time via Schedule Trigger
- **REQ-002**: Produces exactly 3 Gmail drafts per run — one per content variant (Python, JS/TS, C/C++)
- **REQ-003**: Snippet selection is news-driven: Perplexity API (sonar-pro) identifies trending topics with web search, then GitHub Search API finds the associated repos
- **REQ-004**: Fallback for C/C++ — if no trending news topic found, prompt instructs LLM to use a well-known active project (LLVM, CPython, Linux kernel)
- **REQ-005**: Code snippets must be 8-12 lines, max 60 chars per line, self-contained, from recognizable projects
- **REQ-006**: Breakdown generated by `claude-haiku-4-5-20251001` — 3 bullets (breakdown_what, breakdown_responsibility, breakdown_clever), each 30-40 words
- **REQ-007**: Email HTML uses formatted text with inline styles (NOT images) per Track H spec — users can copy/paste code
- **REQ-008**: Gmail drafts created with `operation: createDraft` — NOT sent
- **REQ-009**: Google Sheets rows written with `status: "draft"` — human manually sets `status: "scheduled"` and `scheduled_date` after reviewing Gmail drafts
- **REQ-010**: `issue_number` auto-incremented: query `max(issue_number)` from Sheets at runtime, new value = max + 1
- **REQ-011**: `gmail_draft_id` stored in Sheets to link the tracking row to the Gmail draft
- **CON-001**: n8n instance: `retz8.app.n8n.cloud` (cloud-hosted, no self-hosted tools)
- **CON-002**: No Carbon/ray.so — code blocks rendered as HTML `<pre><code>` with inline CSS
- **CON-003**: No `written_language` field — English only for MVP
- **CON-004**: GitHub API unauthenticated rate limit is 60 req/hr; use authenticated requests (token in header) to get 5000 req/hr
- **GUD-001**: Each Code node uses `Run Once for All Items` mode unless stated otherwise
- **GUD-002**: All HTTP Request nodes set `On Error: Continue` to prevent one language failure from blocking the others
- **PAT-001**: Fixed context (issue_number) from early nodes referenced in late nodes via `$('NodeName').first().json.field`

## 2. Implementation Steps

### Phase 1: Trigger and Issue Number

- GOAL-001: Start the workflow and determine the issue number for this run before any processing begins.

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-001 | Add `Schedule Trigger` node. Set `rule.interval` to `[{ field: "weeks", triggerAtDay: [0], triggerAtHour: 20 }]` (0 = Sunday, 20 = 8pm). | | |
| TASK-002 | Add `Google Sheets` node named `"Read Drafts Sheet"`. Operation: `Get Rows`. Document: `Newsletter` spreadsheet. Sheet: `Newsletter Drafts`. Return All: ON. This fetches all existing rows to find the current max issue_number. | | |
| TASK-003 | Add `Code` node named `"Compute Issue Number"`. Mode: Run Once for All Items. Code: read all rows from input, find max `issue_number` (convert to int, default 0 if no rows), output `{ next_issue_number: max + 1 }`. Full code in Section 2.1 below. | | |

**Code 2.1 — Compute Issue Number:**
```javascript
const rows = $input.all();
let maxIssue = 0;
for (const row of rows) {
  const n = parseInt(row.json.issue_number || '0', 10);
  if (n > maxIssue) maxIssue = n;
}
return [{ json: { next_issue_number: maxIssue + 1 } }];
```

### Phase 2: Trending Topic Discovery

- GOAL-002: Call Perplexity API with a structured prompt to identify 6 trending IT topics (2 per language) and their GitHub search queries.

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-004 | Add `HTTP Request` node named `"Perplexity: Trending Topics"`. Method: POST. URL: `https://api.perplexity.ai/chat/completions`. Headers: `Authorization: Bearer {{ $credentials.perplexityApiKey }}`, `Content-Type: application/json`. Body: JSON (see Section 2.2). | | |
| TASK-005 | Add `Code` node named `"Parse Topics"`. Mode: Run Once for All Items. Parse the Perplexity response content field as JSON. Validate 6 items exist. Output 3 items (one per language), each containing 2 topic candidates. Full code in Section 2.3. | | |

**Request Body 2.2 — Perplexity API:**
```json
{
  "model": "sonar-pro",
  "messages": [
    {
      "role": "system",
      "content": "You are a tech trend analyst for a developer newsletter. Always respond with valid JSON only. No markdown, no explanation — raw JSON."
    },
    {
      "role": "user",
      "content": "Identify the top trending IT topics from the past 7 days that have notable open-source GitHub repositories with clean, readable code.\n\nReturn exactly 6 topics as a JSON object — 2 topics per programming language category.\n\n{\n  \"topics\": [\n    {\n      \"language\": \"Python\",\n      \"topic\": \"DeepSeek R2\",\n      \"description\": \"New open-source LLM achieving strong benchmark performance\",\n      \"github_search_query\": \"deepseek-ai/DeepSeek-R2\",\n      \"fallback_query\": \"language:python sort:stars pushed:>2026-01-01\"\n    }\n  ]\n}\n\nRules:\n- language must be exactly: \"Python\", \"JS/TS\", or \"C/C++\"\n- 2 entries per language (6 total)\n- github_search_query: the specific repo slug (owner/repo) if known, otherwise a search string\n- fallback_query: a broader GitHub search string if the primary query fails\n- For C/C++: if no recent trending topic found this week, use a well-known active project (LLVM, CPython, Linux kernel, Redis, SQLite) — never leave C/C++ empty\n- topic and description must reflect actual events from the past 7 days"
    }
  ]
}
```

**Code 2.3 — Parse Topics:**
```javascript
const item = $input.first();
const content = item.json.choices[0].message.content;

let parsed;
try {
  parsed = JSON.parse(content);
} catch (e) {
  const match = content.match(/```(?:json)?\s*([\s\S]*?)```/);
  if (match) parsed = JSON.parse(match[1]);
  else throw new Error('Failed to parse Perplexity response as JSON: ' + content);
}

const topics = parsed.topics;
const languages = ['Python', 'JS/TS', 'C/C++'];
return languages.map(lang => {
  const candidates = topics.filter(t => t.language === lang);
  return {
    json: {
      language: lang,
      primary: candidates[0] || null,
      secondary: candidates[1] || null
    }
  };
});
```

### Phase 3: GitHub Repo Selection

- GOAL-003: For each language variant, search GitHub for the trending repo and select the best candidate.

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-006 | Add `HTTP Request` node named `"GitHub: Search Repos"`. Method: GET. URL: `https://api.github.com/search/repositories`. Query params: `q={{ $json.primary.github_search_query }}&sort=stars&order=desc&per_page=5`. Headers: `Authorization: Bearer {{ $credentials.githubToken }}`, `Accept: application/vnd.github.v3+json`. On Error: Continue. | | |
| TASK-007 | Add `Code` node named `"Select Best Repo"`. Score repos by stars + recency. If 0 results, set `search_failed: true` for fallback routing. Output: `{ language, repo_full_name, repo_url, repo_description, default_branch }`. Full code in Section 2.4. | | |
| TASK-007a | Add `IF` node named `"Needs Fallback?"`. Condition: `{{ $json.search_failed }}` equals `true`. TRUE branch → fallback search. FALSE branch → continue to snippet extraction. | | |
| TASK-007b | Add `HTTP Request` node on TRUE branch named `"GitHub: Fallback Search"`. Same config as TASK-006 but query param uses `{{ $json.secondary.github_search_query }}`. | | |
| TASK-007c | Add `Merge` node named `"Merge Repo Results"`. Mode: `Combine`. Merges primary-found and fallback-found streams back into one. | | |

**Code 2.4 — Select Best Repo:**
```javascript
const item = $input.first();
const results = item.json.items || [];

if (results.length === 0) {
  return [{ json: { ...item.json, search_failed: true } }];
}

const now = Date.now();
const ninetyDaysMs = 90 * 24 * 60 * 60 * 1000;

const scored = results.map(repo => {
  let score = 0;
  if (repo.stargazers_count > 1000) score += 3;
  else if (repo.stargazers_count > 100) score += 1;
  if (now - new Date(repo.updated_at).getTime() < ninetyDaysMs) score += 2;
  if (repo.description && repo.description.length > 10) score += 1;
  return { repo, score };
});

scored.sort((a, b) => b.score - a.score);
const best = scored[0].repo;

return [{
  json: {
    language: item.json.language,
    search_failed: false,
    repo_full_name: best.full_name,
    repo_url: best.html_url,
    repo_description: best.description || '',
    default_branch: best.default_branch || 'main',
    repo_stars: best.stargazers_count,
    primary: item.json.primary,
    secondary: item.json.secondary
  }
}];
```

### Phase 4: Snippet Extraction

- GOAL-004: Fetch the repo file tree, identify the best candidate source file, retrieve its content, and extract an 8-12 line self-contained snippet.

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-008 | Add `HTTP Request` node named `"GitHub: Get File Tree"`. Method: GET. URL: `https://api.github.com/repos/{{ $json.repo_full_name }}/git/trees/{{ $json.default_branch }}?recursive=1`. Headers: same GitHub auth. On Error: Continue. | | |
| TASK-009 | Add `Code` node named `"Filter Candidate Files"`. Filter tree by language extension, apply blocklist (tests, configs, generated files), rank by depth and file type. Output top 1 file path. Full code in Section 2.5. | | |
| TASK-010 | Add `HTTP Request` node named `"GitHub: Fetch File Content"`. Method: GET. URL: `https://raw.githubusercontent.com/{{ $json.repo_full_name }}/{{ $json.default_branch }}/{{ $json.file_path }}`. No auth header required. On Error: Continue. | | |
| TASK-011 | Add `Code` node named `"Extract Snippet"`. Sliding window scoring over file lines to find best 8-12 line self-contained snippet. Fallback: first 10 lines. Full code in Section 2.6. | | |

**Code 2.5 — Filter Candidate Files:**
```javascript
const item = $input.first();
const tree = item.json.tree || [];

const extensionMap = {
  'Python': ['.py'],
  'JS/TS': ['.ts', '.tsx', '.js', '.jsx'],
  'C/C++': ['.c', '.cpp', '.cc', '.cxx', '.h', '.hpp']
};

const lang = item.json.language;
const validExts = extensionMap[lang] || [];

const blocklistPatterns = [
  /test[s]?[_\/]/, /_test\./, /\.test\./, /\.spec\./,
  /__init__\.py$/, /setup\.py$/, /conftest\.py$/,
  /index\.(ts|js)$/, /\.d\.ts$/,
  /generated/, /auto_/, /pb\./, /\.min\.js$/,
  /config[s]?\./i, /\.config\./
];

const isBlocked = (path) => blocklistPatterns.some(p => p.test(path));
const hasValidExt = (path) => validExts.some(ext => path.endsWith(ext));

const candidates = tree
  .filter(f => f.type === 'blob' && hasValidExt(f.path) && !isBlocked(f.path))
  .map(f => {
    let score = 0;
    if (/^src\//.test(f.path) || /^lib\//.test(f.path)) score += 2;
    score -= f.path.split('/').length;
    if (f.path.endsWith('.ts') || f.path.endsWith('.tsx')) score += 1;
    return { path: f.path, score };
  })
  .sort((a, b) => b.score - a.score);

if (candidates.length === 0) {
  return [{ json: { ...item.json, extraction_failed: true } }];
}

return [{ json: { ...item.json, extraction_failed: false, file_path: candidates[0].path } }];
```

**Code 2.6 — Extract Snippet:**
```javascript
const item = $input.first();
const content = typeof $input.first().json === 'string'
  ? $input.first().json
  : JSON.stringify($input.first().json);
const lines = content.split('\n');

if (lines.length < 8) {
  return [{ json: { ...item.json, extraction_failed: true } }];
}

let bestWindow = null;
let bestScore = -Infinity;

for (let windowSize = 8; windowSize <= 12; windowSize++) {
  for (let start = 0; start <= lines.length - windowSize; start++) {
    const window = lines.slice(start, start + windowSize);
    let score = 0;

    const hasDef = window.some(l =>
      /^\s*(def |class |function |const |export (function|const|class)|async function|public |private |template )/.test(l)
    );
    if (!hasDef) continue;

    const longLines = window.filter(l => l.length > 60).length;
    score -= longLines * 2;

    const logicLines = window.filter(l =>
      l.trim().length > 3 &&
      !/^(import|from|#|\/\/|\/\*)/.test(l.trim()) &&
      !/^(pass|return None)$/.test(l.trim())
    ).length;
    score += logicLines;
    score -= start * 0.01;

    if (score > bestScore) {
      bestScore = score;
      bestWindow = { lines: window, startLine: start + 1 };
    }
  }
}

if (!bestWindow) {
  bestWindow = { lines: lines.slice(0, 10), startLine: 1 };
}

return [{ json: { ...item.json, snippet: bestWindow.lines.join('\n'), snippet_start_line: bestWindow.startLine } }];
```

### Phase 5: Breakdown Generation

- GOAL-005: Call Claude Haiku to generate the 3-bullet breakdown and file_intent for each snippet.

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-012 | Add `HTTP Request` node named `"Claude: Generate Breakdown"`. Method: POST. URL: `https://api.anthropic.com/v1/messages`. Headers: `x-api-key: {{ $credentials.anthropicApiKey }}`, `anthropic-version: 2023-06-01`, `Content-Type: application/json`. Body: JSON (see Section 2.7). On Error: Continue. | | |
| TASK-013 | Add `Code` node named `"Parse Breakdown"`. Extract JSON from `content[0].text`. Map to: `file_intent`, `breakdown_what`, `breakdown_responsibility`, `breakdown_clever`. Full code in Section 2.8. | | |

**Request Body 2.7 — Claude Haiku:**
```json
{
  "model": "claude-haiku-4-5-20251001",
  "max_tokens": 400,
  "messages": [
    {
      "role": "user",
      "content": "Analyze this code snippet from {{ $json.repo_full_name }}:\n\n```{{ $json.language }}\n{{ $json.snippet }}\n```\n\nReturn ONLY a JSON object:\n{\n  \"file_intent\": \"[3-5 words, noun phrase, e.g. 'Bash command validation hook']\",\n  \"breakdown_what\": \"[30-40 words: what this code does, starting with a verb]\",\n  \"breakdown_responsibility\": \"[30-40 words: its role in the codebase]\",\n  \"breakdown_clever\": \"[30-40 words: the non-obvious insight, NOT a restatement of visible code]\"\n}\n\nRules:\n- file_intent: 3-5 words, noun phrase\n- Each breakdown field: 30-40 words\n- breakdown_clever must reveal something non-obvious to a mid-level engineer (2-5 YoE)\n- JSON only, no markdown, no explanation"
    }
  ]
}
```

**Code 2.8 — Parse Breakdown:**
```javascript
const item = $input.first();
const text = item.json.content[0].text;

let parsed;
try {
  parsed = JSON.parse(text);
} catch (e) {
  const match = text.match(/```(?:json)?\s*([\s\S]*?)```/);
  if (match) parsed = JSON.parse(match[1]);
  else throw new Error('Failed to parse Claude response: ' + text);
}

return [{
  json: {
    ...item.json,
    file_intent: parsed.file_intent,
    breakdown_what: parsed.breakdown_what,
    breakdown_responsibility: parsed.breakdown_responsibility,
    breakdown_clever: parsed.breakdown_clever
  }
}];
```

### Phase 6: Email Composition and Gmail Draft

- GOAL-006: Compose the full HTML email and save it as a Gmail draft. Capture the returned gmail_draft_id.

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-014 | Add `Code` node named `"Compose HTML Email"`. Build mobile-first HTML email (inline CSS, syntax-highlighted code block, challenge, breakdown, project context). References `$('Compute Issue Number')` for issue_number. Output: `{ subject, html_body, issue_number }`. Full code in Section 2.9. | | |
| TASK-015 | Add `Gmail` node named `"Create Gmail Draft"`. Resource: `Draft`. Operation: `Create`. Subject: `{{ $json.subject }}`. Message (HTML): `{{ $json.html_body }}`. Leave To empty (no recipient on draft). | | |
| TASK-016 | Add `Code` node named `"Extract Draft ID"`. Extract `id` from Gmail node output into `gmail_draft_id`. Full code in Section 2.10. | | |

**Code 2.9 — Compose HTML Email:**
```javascript
const item = $input.first();
const { language, snippet, file_intent, repo_full_name, repo_url, repo_description,
        breakdown_what, breakdown_responsibility, breakdown_clever } = item.json;

const issueNumber = $('Compute Issue Number').first().json.next_issue_number;
const paddedIssue = String(issueNumber).padStart(3, '0');
const subject = `Can you read this #${paddedIssue}: ${file_intent}`;

function highlight(code, lang) {
  let h = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  if (lang === 'Python') {
    h = h
      .replace(/\b(def|class|import|from|return|if|else|elif|for|while|with|as|in|not|and|or|True|False|None|raise|try|except|finally|pass|yield|lambda)\b/g,
        '<span style="color:#cf222e;">$1</span>')
      .replace(/(#[^\n]*)/g, '<span style="color:#6e7781;">$1</span>')
      .replace(/("(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*')/g, '<span style="color:#0a3069;">$1</span>');
  } else if (lang === 'JS/TS') {
    h = h
      .replace(/\b(const|let|var|function|return|if|else|for|while|class|import|export|from|async|await|new|this|typeof|instanceof|true|false|null|undefined)\b/g,
        '<span style="color:#cf222e;">$1</span>')
      .replace(/(\/\/[^\n]*)/g, '<span style="color:#6e7781;">$1</span>')
      .replace(/(`(?:[^`\\]|\\.)*`|"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*')/g, '<span style="color:#0a3069;">$1</span>');
  } else if (lang === 'C/C++') {
    h = h
      .replace(/\b(int|char|void|return|if|else|for|while|struct|class|template|typename|const|static|inline|auto|bool|true|false|nullptr|new|delete|public|private|protected|virtual|override)\b/g,
        '<span style="color:#cf222e;">$1</span>')
      .replace(/(\/\/[^\n]*|\/\*[\s\S]*?\*\/)/g, '<span style="color:#6e7781;">$1</span>')
      .replace(/("(?:[^"\\]|\\.)*")/g, '<span style="color:#0a3069;">$1</span>');
  }
  return h;
}

const highlightedCode = highlight(snippet, language);

const html_body = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;font-size:16px;line-height:1.6;color:#24292f;background:#ffffff;">
  <div style="max-width:600px;margin:0 auto;padding:40px 20px;">
    <pre style="font-family:Consolas,Monaco,'Courier New',monospace;font-size:14px;line-height:1.6;background-color:#f6f8fa;padding:16px;border-left:3px solid #0969da;border-radius:6px;overflow-x:auto;color:#24292f;margin:0 0 24px 0;white-space:pre-wrap;word-wrap:break-word;"><code>${highlightedCode}</code></pre>
    <p style="margin:0 0 16px 0;font-size:15px;color:#57606a;font-style:italic;">Before scrolling: what does this do?</p>
    <div style="margin:24px 0;text-align:center;letter-spacing:8px;color:#d0d7de;font-size:20px;">• • •</div>
    <h2 style="margin:0 0 16px 0;font-size:18px;font-weight:600;">The Breakdown</h2>
    <ul style="margin:0 0 24px 0;padding-left:24px;line-height:1.8;">
      <li style="margin-bottom:12px;"><strong>What it does:</strong> ${breakdown_what}</li>
      <li style="margin-bottom:12px;"><strong>Key responsibility:</strong> ${breakdown_responsibility}</li>
      <li style="margin-bottom:12px;"><strong>The clever part:</strong> ${breakdown_clever}</li>
    </ul>
    <hr style="margin:32px 0;border:none;border-top:1px solid #d0d7de;">
    <h3 style="margin:0 0 8px 0;font-size:15px;font-weight:600;">Project Context</h3>
    <p style="margin:0 0 32px 0;font-size:14px;color:#57606a;">
      From <a href="${repo_url}" style="color:#0969da;text-decoration:none;">${repo_full_name}</a>. ${repo_description}
    </p>
    <div style="padding-top:20px;border-top:1px solid #d0d7de;font-size:13px;color:#57606a;">
      Python, JS/TS, C/C++ | <a href="https://iris-codes.com/unsubscribe?token=UNSUBSCRIBE_TOKEN" style="color:#0969da;text-decoration:none;">Unsubscribe</a>
    </div>
  </div>
</body>
</html>`;

return [{ json: { ...item.json, subject, html_body, issue_number: issueNumber } }];
```

**Code 2.10 — Extract Draft ID:**
```javascript
const item = $input.first();
return [{ json: { ...item.json, gmail_draft_id: item.json.id } }];
```

### Phase 7: Google Sheets Tracking

- GOAL-007: Write one tracking row per language variant to the Newsletter Drafts sheet with status "draft".

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-017 | Add `Google Sheets` node named `"Append Draft Row"`. Credential: Google OAuth2. Operation: Append Row. Document: `Newsletter`. Sheet: `Newsletter Drafts`. Data Mode: Define Fields Below. Column mapping per Section 2.11. Runs 3 times (once per language item). | | |

**Column Mapping 2.11 — Google Sheets Append:**

| Sheet Column | n8n Value |
|---|---|
| `issue_number` | `{{ $json.issue_number }}` |
| `status` | `draft` |
| `content_variant` | `{{ $json.language }}` |
| `programming_language` | `{{ $json.language }}` |
| `file_intent` | `{{ $json.file_intent }}` |
| `repository_name` | `{{ $json.repo_full_name }}` |
| `repository_url` | `{{ $json.repo_url }}` |
| `repository_description` | `{{ $json.repo_description }}` |
| `gmail_draft_id` | `{{ $json.gmail_draft_id }}` |
| `created_date` | `{{ $now.toISO() }}` |
| `scheduled_date` | *(leave empty — human sets during review)* |
| `sent_date` | *(leave empty)* |
| `source` | `perplexity_trending` |

### Phase 8: Testing and Verification

- GOAL-008: Verify the complete workflow end-to-end.

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-018 | Activate workflow. First test: manually trigger via "Execute Workflow" button (do not wait for Sunday). | | |
| TASK-019 | Verify "Parse Topics" output: 3 items, 2 candidates each, all 3 languages present. | | |
| TASK-020 | Verify "Select Best Repo" output: each item has `repo_full_name` populated, `search_failed: false`. | | |
| TASK-021 | Verify "Extract Snippet" output: `snippet` is 8-12 lines, no line exceeds 60 chars, not just imports. | | |
| TASK-022 | Verify "Parse Breakdown" output: all 4 fields present, `file_intent` is 3-5 words. | | |
| TASK-023 | Open Gmail: confirm 3 new drafts. Open each — code block styled, syntax highlighted, subject line correct, layout renders on mobile. | | |
| TASK-024 | Open Newsletter Drafts sheet: confirm 3 new rows, `status: "draft"`, `gmail_draft_id` populated, same `issue_number` across all 3. | | |
| TASK-025 | Test human review handoff: set one row `status: "scheduled"`, set `scheduled_date` to past Mon/Wed/Fri 7am. Verify Workflow 2 picks it up on next trigger. | | |

## 3. Alternatives

- **ALT-001**: HN Algolia API instead of Perplexity — rejected; returns raw links requiring fragile GitHub URL extraction with no language awareness
- **ALT-002**: GitHub Trending page scraping — rejected; no official API, fragile HTML parsing
- **ALT-003**: Carbon/ray.so for code images — rejected per Track H; HTML inline styles are copyable, accessible, faster
- **ALT-004**: Store all content in Google Sheets (no Gmail drafts) — rejected; Gmail draft review is more ergonomic for evaluating email formatting
- **ALT-005**: OpenAI with Responses API instead of Perplexity — rejected; Perplexity sonar-pro has web search built-in, simpler HTTP Request config in n8n

## 4. Dependencies

- **DEP-001**: Perplexity API key — add as n8n credential, model `sonar-pro` required
- **DEP-002**: GitHub Personal Access Token — add as n8n credential for 5000 req/hr rate limit
- **DEP-003**: Anthropic API key — add as n8n credential (separate from backend usage)
- **DEP-004**: Gmail OAuth2 — already configured in n8n for Workflows 2 and 3
- **DEP-005**: Google Sheets OAuth2 — already configured in n8n for Workflows 2 and 3
- **DEP-006**: `Newsletter Drafts` sheet must exist in `Newsletter` Google Sheets doc with columns from Section 2.11

## 5. Files

- **FILE-001**: `docs/tasks/track-g/track-g-implementation-plan.md` — this file
- **FILE-002**: `docs/tasks/n8n-workflows/workflow-content-pipeline.md` — n8n node-by-node build guide (same content, workflow doc format)
- **FILE-003**: n8n Workflow 1 — configured in n8n UI at `retz8.app.n8n.cloud`, no code files in repo
- **FILE-004**: `docs/tasks/n8n-workflows/google-sheets-drafts-schema.md` — Drafts sheet schema reference

## 6. Testing

- **TEST-001**: Perplexity returns valid JSON with 6 topics (2 per language) — check "Parse Topics" node in Executions tab
- **TEST-002**: GitHub Search returns at least 1 repo per language variant
- **TEST-003**: Snippet is 8-12 lines, all lines <= 60 chars
- **TEST-004**: Claude response parses cleanly — all 4 fields present
- **TEST-005**: HTML email renders correctly in Gmail on desktop and mobile
- **TEST-006**: Three Gmail drafts created, three Sheets rows written, issue_number consistent across all 3
- **TEST-007**: Workflow 2 picks up a row after manually setting status to "scheduled"

## 7. Risks & Assumptions

- **RISK-001**: Perplexity response format varies — mitigated by JSON-only system prompt + markdown code block fallback parsing
- **RISK-002**: GitHub repo has no snippet-worthy files — mitigated by fallback to first 10 lines of best-scored file
- **RISK-003**: Claude Haiku breakdown under 30 words — acceptable for MVP
- **RISK-004**: Gmail createDraft returns unexpected response shape — verify `id` field path during TASK-018 test
- **RISK-005**: C/C++ trending topics absent from weekly news — mitigated by explicit fallback instruction in Perplexity prompt
- **ASSUMPTION-001**: `retz8.app.n8n.cloud` supports all required node types
- **ASSUMPTION-002**: Perplexity `sonar-pro` available on active API key tier
- **ASSUMPTION-003**: `Newsletter Drafts` sheet exists with correct column headers

## 8. Related Specifications / Further Reading

- [`docs/tasks/track-g-newsletter-content-pipeline.md`](../track-g-newsletter-content-pipeline.md) — Track G overview and acceptance criteria
- [`docs/tasks/n8n-workflows/workflow-content-pipeline.md`](../n8n-workflows/workflow-content-pipeline.md) — n8n build guide (workflow doc format)
- [`docs/tasks/n8n-workflows/google-sheets-drafts-schema.md`](../n8n-workflows/google-sheets-drafts-schema.md) — Drafts sheet schema
- [`docs/tasks/track-h/track-h-summary.md`](../track-h/track-h-summary.md) — Email format spec (inline CSS, syntax colors)
- [`docs/newsletter-n8n-plan.md`](../../newsletter-n8n-plan.md) — Original 3-workflow architecture overview
