---
goal: Add shared webhook secret (api_key) to /subscribe POST request
version: 1.0
date_created: 2026-02-21
last_updated: 2026-02-21
owner: Snippet Web
status: 'Planned'
tags: [security, feature, chore]
---

# Introduction

![Status: Planned](https://img.shields.io/badge/status-Planned-blue)

Adds a shared `api_key` field to the `/subscribe` POST payload in `SignupForm.tsx`. The n8n webhook now validates this key against a server-side variable (`$vars.WEBHOOK_SECRET`) and rejects requests that omit or send an incorrect value. The Origin header is already sent automatically by the browser for cross-origin fetch calls — no code change is required for that part of the fix.

This is the frontend half of the C1 security fix. The n8n half is documented in `action-plan.md` (Fix 1).

## 1. Requirements & Constraints

- **REQ-001**: The `api_key` field must be included in the JSON body of every POST to `/subscribe`, with the value read from `import.meta.env.VITE_WEBHOOK_SECRET`.
- **REQ-002**: The env variable name must be `VITE_WEBHOOK_SECRET` (Vite requires the `VITE_` prefix for client-accessible env vars).
- **REQ-003**: The change must work in both production (`VITE_APP_ENV=prod`) and non-production environments — `WEBHOOK_BASE` already resolves to the correct n8n URL per environment, no additional branching is needed.
- **CON-001**: Do not remove `source` or `subscribed_date` from the payload. n8n now ignores them server-side, but removing them is out of scope for this fix and must not be done here.
- **CON-002**: Do not change any form state, error handling, UI rendering, or any other logic in the component.
- **CON-003**: No new TypeScript types or interfaces are required — `api_key` is a plain string added to the existing inline payload object.
- **CON-004**: The `VITE_WEBHOOK_SECRET` env variable will be added to `.env` files by the engineer manually. This plan does not create or modify `.env` files.
- **SEC-001**: The secret value must never be hardcoded in source code. It must always be read from `import.meta.env.VITE_WEBHOOK_SECRET`.

## 2. Implementation Steps

### Implementation Phase 1

- GOAL-001: Add `api_key` to the fetch payload in `handleFinalSubmit`.

| Task | Description | Completed | Date |
|------|-------------|-----------|------|
| TASK-001 | In `web/src/components/snippet/SignupForm.tsx`, locate the `payload` object inside `handleFinalSubmit` (line 103–108). Add `api_key: import.meta.env.VITE_WEBHOOK_SECRET` as a new field at the end of the object, after `subscribed_date`. The resulting object must be: `{ email, programming_languages, source, subscribed_date, api_key }`. No other changes to this function. | | |
| TASK-002 | Run `npm run typecheck` (or `npx tsc --noEmit`) from the repo root to confirm no TypeScript errors were introduced. | | |
| TASK-003 | Run `npm run lint` (or `npx eslint web/src/components/snippet/SignupForm.tsx`) to confirm no lint errors. | | |
| TASK-004 | Run `npm run build` to confirm the production build succeeds. | | |

## 3. Alternatives

- **ALT-001**: Send the secret as a custom request header (`X-Webhook-Secret`) instead of in the body. Rejected — the n8n validation on the server side was explicitly designed for a body field (`api_key`) to match the user's stated preference. Changing to a header would require updating both this plan and the n8n Code node.
- **ALT-002**: Use n8n's built-in Header Auth on the Webhook node instead of a Code node check. Rejected — already decided in Phase 2 discussion. The body field approach was the agreed design.
- **ALT-003**: Read the secret from a runtime config endpoint instead of a build-time env var. Rejected — over-engineered for a static secret at this scale. Build-time env var is standard for Vite apps.

## 4. Dependencies

- **DEP-001**: `VITE_WEBHOOK_SECRET` env variable must be set in `.env.local` (dev) and in the production deployment environment before the fix is functional. The engineer adds this manually using the value generated by `openssl rand -hex 32`.
- **DEP-002**: The n8n Fix 1 (action-plan.md) must be applied first — specifically, `$vars.WEBHOOK_SECRET` must exist in n8n Variables and the Code node check must be active. If the n8n fix is not applied, adding `api_key` to the FE payload is harmless (the field is ignored by the current Code node).

## 5. Files

- **FILE-001**: `web/src/components/snippet/SignupForm.tsx` — only file modified. Change is limited to the `payload` object in `handleFinalSubmit` (lines 103–108).

## 6. Testing

- **TEST-001**: With a correctly configured `VITE_WEBHOOK_SECRET` matching `$vars.WEBHOOK_SECRET` in n8n, submitting the signup form must return a 200 success response and trigger the confirmation email flow.
- **TEST-002**: If `VITE_WEBHOOK_SECRET` is missing or empty, the POST body will include `api_key: undefined`. The n8n Code node must reject this with a 403. Verify this in the browser network tab.
- **TEST-003**: Submitting with an incorrect secret value (manually patched in browser devtools) must return 403 from the webhook.
- **TEST-004**: Confirm `source` and `subscribed_date` are still present in the request body in the browser network tab — these fields must not have been removed.

## 7. Risks & Assumptions

- **RISK-001**: If `VITE_WEBHOOK_SECRET` is not set at build time, `import.meta.env.VITE_WEBHOOK_SECRET` evaluates to `undefined`, which becomes the string `"undefined"` when JSON-serialized. This will cause all subscribe requests to be rejected with 403. Mitigation: ensure the env var is set before deploying.
- **ASSUMPTION-001**: The browser automatically includes the `Origin` header on cross-origin fetch calls (which it does per the Fetch spec). No code is needed to set it explicitly.
- **ASSUMPTION-002**: `WEBHOOK_BASE` already resolves to the correct n8n webhook URL for both prod and non-prod environments. This plan relies on that existing behavior and does not change it.

## 8. Related Specifications / Further Reading

- `docs/tasks/3-track-a-n8n-security-check/action-plan.md` — Fix 1 (n8n side of C1)
- `docs/tasks/3-track-a-n8n-security-check.md` — Phase 2 findings and decisions
- `web/src/config/webhooks.ts` — WEBHOOK_BASE environment resolution
